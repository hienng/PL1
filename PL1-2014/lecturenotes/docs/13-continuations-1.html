<!DOCTYPE html>
<html>
<head>
    <title>13-continuations-1.scala</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <style type="text/css">
        /*--------------------- Layout and Typography ----------------------------*/
        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
            font-size: 15px;
            line-height: 22px;
            color: #252519;
            margin: 0; padding: 0;
        }
        a {
            color: #261a3b;
        }
        a:visited {
            color: #261a3b;
        }
        p {
            margin: 0 0 15px 0;
        }
        h4, h5, h6 {
            color: #333;
            padding: 6px 0 6px 0;
            font-size: 13px;
        }
        h2, h3 {
            padding-bottom: 15px;
            color: #000;
            overflow: hidden;
        }
        h1 {
            /*padding-top: 40px;*/
            padding-bottom: 15px;
            color: #000;
        }
        #container {
            position: relative;
        }
        /*#background {
            position: fixed;
            top: 0; left: 525px; right: 0; bottom: 0;
            background: #f5f5ff;
            border-left: 1px solid #e5e5ee;
            z-index: -1;
        }*/
        #jump_to, #jump_page {
            background: white;
            -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777;
            -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px;
            font: 10px Arial;
            text-transform: uppercase;
            cursor: pointer;
            text-align: right;
        }
        #jump_to, #jump_wrapper {
            position: fixed;
            right: 0; top: 0;
            padding: 5px 10px;
        }
        #jump_wrapper {
            padding: 0;
            display: none;
        }
        #jump_to:hover #jump_wrapper {
            display: block;
        }
        #jump_page {
            padding: 5px 0 3px;
            margin: 0 0 25px 25px;
        }
        #jump_page .source {
            display: block;
            padding: 5px 10px;
            text-decoration: none;
            border-top: 1px solid #eee;
        }
        #jump_page .source:hover {
            background: #f5f5ff;
        }
        #jump_page .source:first-child {
        }
        table td {
            border: 0;
            outline: 0;
        }
        td.docs, th.docs {
            max-width: 450px;
            min-width: 450px;
            min-height: 5px;
            padding: 10px 25px 1px 50px;
            overflow-x: hidden;
            vertical-align: top;
            text-align: left;
        }
        .docs pre {
            margin: 15px 0 15px;
            padding-left: 15px;
        }
        .docs p tt, .docs p code, .doc code {
            background: #f8f8ff;
            border: 1px solid #dedede;
            font-size: 12px;
            padding: 0 0.2em;
        }
        .pilwrap {
            position: relative;
        }
        .pilcrow {
            font: 12px Arial;
            text-decoration: none;
            color: #454545;
            position: absolute;
            top: 3px; left: -20px;
            padding: 1px 2px;
            opacity: 0;
            -webkit-transition: opacity 0.2s linear;
        }
        td.docs:hover .pilcrow {
            opacity: 1;
        }
        td.code, th.code {
            padding: 10px 10px 10px 50px;
            width: 100%;
            vertical-align: top;
            background: #f5f5ff;
            border-left: 1px solid #e5e5ee;
        }
        pre, tt, code {
            font-size: 12px; line-height: 18px;
            font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
            margin: 0; padding: 0;
        }

        /*---------------------- Prettify Syntax Highlighting -----------------------------*/
        .str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun{color:#660}.pln{color:#000}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec{color:#606}pre.prettyprint{padding:2px;border:1px solid #888}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}@media print{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun{color:#440}.pln{color:#000}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}

        table.doc { margin-bottom: 20px; }
        td.doc { border-bottom: 1px dashed #708090; }
        td.param { font-weight: bold; }
        td.return { font-weight: bold; text-decoration: underline; }
    </style>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.js" type="text/javascript"></script>
    <script src="https://google-code-prettify.googlecode.com/svn/trunk/src/lang-scala.js" type="text/javascript"></script>
</head>

<body onload="prettyPrint()">
<div id="container">
    <div id="background"></div>
    <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
            <div id="jump_page">
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/01-intro.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/01-intro.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/02-desugaring.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/02-desugaring.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/03-ae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/03-ae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/04-wae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/04-wae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/05-f1wae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/05-f1wae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/06-fae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/06-fae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/07-lcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/07-lcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/08-rcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/08-rcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/09-bcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/09-bcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/10-gc.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/10-gc.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/11-syntacticvsmeta.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/11-syntacticvsmeta.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/12-churchencoding.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/12-churchencoding.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/13-continuations-1.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/13-continuations-1.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/14-continuations-2.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/14-continuations-2.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/17-firstclasscontinuations.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/17-firstclasscontinuations.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/18-monads.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/18-monads.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/19-monads.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/19-monads.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/20-iomonad.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/20-iomonad.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/21-defunctionalization.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/21-defunctionalization.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/22-typesystems.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/22-typesystems.html
                </a>
                
            </div>
        </div>
    </div>

    <table cellpadding="0" cellspacing="0">
        <thead>
        <tr>
            <th class="docs">
                <h1>13-continuations-1.scala</h1>
            </th>
            <th class="code"></th>
        </tr>
        </thead>
        <tbody>
        
        <tr id="section_0">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_0">&#182;</a>
                </div>
                <h1>Programming in Continuation-Passing Style (CPS)</h1>
<p>With the programming language features we have seen so far, the
<br  />order of execution was always implicit and fixed for a given
<br  />language. Today, we learn how to write a program so that it can
<br  />specify its own order of execution explicitly, and even change
<br  />the order of execution. The key concept will be the notion of the
<br  />continuation<em> of a point during execution of a program. The
<br  />continuation is the part of the computation that has to be
<br  />executed after that point, that is, the continuation describes
<br  />how to </em>continue* execution.</p>
<p>Remember how we made functions first-class, and that gaves us
<br  />additional expressivity because we could write functions over
<br  />functions and store functions in datastructures? Today is the
<br  />first of a couple of lectures about making continuations
<br  />first-class, and again, this will give us additional expressivity
<br  />because we will be able to write functions over continuations and
<br  />store continuations in datastructures. Making things first-class
<br  />in order to gain expressivity is a common theme in the world of
<br  />programming languages.</p>
<p>But before we learn more about continuations, here are some
<br  />examples of programs that require unusual orders of execution,
<br  />and can therefore benefit from continuations:</p>
<p>In a debugger, you want to stop execution of the program to</p>
<pre><code>inspect the state, and then resume execution at the precise
point where it stopped.
</code></pre>
<p>With lightweight concurrency, you want to execute multiple</p>
<pre><code>threads of execution at the same time, jumping back and forth
between them.
</code></pre>
<p>In a distributed system, you want to halt execution on one</p>
<pre><code>computer while you wait for the execution on some other
computer to finish.
</code></pre>
<p>Such unusual orders of execution are also called control
<br  />effects. Programming with continuations supports these and many
<br  />other examples of control effects. Today, we will focus on
<br  />distributed systems, or specifically, the basic architecture of a
<br  />Web application.</p>
<h2>Running example: A very simple calculator</h2>
<p>We use a very simple program as a running example. The program
<br  />asks the users for two numbers and then displays the sum of the
<br  />numbers. Here is the desktop version of this calculator:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object Desktop {
  def inputNumber(prompt: String): Int = {
    print(prompt + &quot;&gt; &quot;)
    Integer.parseInt(readLine())
  }

  def program() {
    println(&quot;The sum is &quot; +
      (inputNumber(&quot;First number&quot;) +
        inputNumber(&quot;Second number&quot;)) +
      &quot;.&quot;)
  }
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_1">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_1">&#182;</a>
                </div>
                <p>Here is an example interaction with this simple program:</p>
<pre><code>scala&gt; Desktop.program()
First number&gt; 2
Second number&gt; 40
The sum is 42.
</code></pre>
<p>Note that <code>Desktop.program</code> performs the following steps, one
<br  />after another:</p>
<ol>
<li>Ask the user for the first number.</li>
<li>Ask the user for the second number.</li>
<li>Print the sum of the two numbers.</li>
</ol>
<p>We don't have to specify that these steps are done in this order,
<br  />and we cannot change the order. This fixed order of execution
<br  />becomes a problem when we consider how a Web version of the
<br  />calculator would have to work. The user interaction would be
<br  />distributed over multiple pages:</p>
<ol>
<li><p>the first number is entered on the first page</p>
</li>
<li><p>when the first number is submitted,
<br  />a form to enter the second number is shown</p>
</li>
<li><p>when the second number is submitted,
<br  />a form with the result is generated and shown.</p>
</li>
</ol>
<p>Even this &ldquo;addition server&rdquo; is difficult to implement. Because
<br  />HTTP is a stateless protocol (for good reasons), every Web
<br  />program is basically forced to terminate after every request, and
<br  />we cannot just use the <code>Desktop.program</code> operation that we wrote
<br  />before. Instead, the Web developer must turn this application
<br  />into three programs for the three pages:</p>
<ol>
<li><p>The first program displays the first form.</p>
</li>
<li><p>The second program consumes the form values from the first
<br  />form, and generates the second form.</p>
</li>
<li><p>The third program consumes the form values from the second
<br  />form, computes the output, and generates the result.</p>
</li>
</ol>
<p>For the purpose of this lecture, we ignore HTTP, HTML etc. and
<br  />just output strings. But the programs we write have the same
<br  />structure that a real Web program could have.</p>
<h2>First try: Failing to remember firstNumber</h2>
<p>Let's try to translate the Desktop version to a Web version of
<br  />the calculator.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object FirstTry {
</code></pre>
            </td>
        </tr>
        
        <tr id="section_2">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_2">&#182;</a>
                </div>
                <p>We change the <code>inputNumber</code> method to only print the prompt
<br  />but not actually read any input from the user. In a Web
<br  />program, all interaction with the user is done by the
<br  />browser, but we try to model the server here. So instead of
<br  />reading input from the user, we print a line with
<br  />information where to send the input when it becomes
<br  />available. In a Web program, this would be an URL the
<br  />browser would send the input to after the user clicks the
<br  />&ldquo;submit&rdquo; button.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def inputNumber(prompt: String, name: String) = {
    print(prompt + &quot;&gt; &quot;)
    print(&quot;Send answer to &quot; + name)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_3">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_3">&#182;</a>
                </div>
                <p>We split the <code>program</code> method into three methods that
<br  />correspond to the three steps above. The first program asks the
<br  />user to call the second program with the first number</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def program1() {
    inputNumber(&quot;First number&quot;, &quot;FirstTry.program2&quot;)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_4">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_4">&#182;</a>
                </div>
                <p>The second program gets the first number as an argument but
<br  />doesn't do anything with it. Instead, it just asks the user to
<br  />call the third program with the second number.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def program2(firstNumber: Int) {
    inputNumber(&quot;Second number&quot;, &quot;FirstTry.program3&quot;)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_5">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_5">&#182;</a>
                </div>
                <p>The third program gets the second number as an argument and
<br  />would like to add the first number and the second number. But
<br  />this doesn't work because the first number is no longer known.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def program3(secondNumber: Int) {
    // commented out because firstNumber is not known here
    //
    // println(&quot;The sum is &quot; +
    //   (firstNumber + secondNumber) +
    //   &quot;.&quot;)
  }
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_6">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_6">&#182;</a>
                </div>
                <p>Our first try failed because when we learn the second number, we
<br  />have already forgotten the first number.</p>
<h2>Second try: Storing firstNumber in a database</h2>
<p>The problem with the code in <code>FirstTry</code> was that the third
<br  />program knew only the second number, but not the first
<br  />number. But the first number is known to second program. To
<br  />communicate information from one Web program to another, a Web
<br  />developer might use a Java Servlet session object, or a database
<br  />field, to store that information between the two program
<br  />runs. (Application developers are often pushed to do this because
<br  />that is the feature most conveniently supported by the language
<br  />and API they are employing). We can model this solution idea in
<br  />Scala as follows:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object Database {
</code></pre>
            </td>
        </tr>
        
        <tr id="section_7">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_7">&#182;</a>
                </div>
                <p>Both the inputNumber method and the first program are the same
<br  />as in the first try.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def inputNumber(prompt: String, name: String) = {
    println(prompt + &quot;&gt; &quot;)
    println(&quot;Send answer to &quot; + name)
  }

  def program1() {
    inputNumber(&quot;First number&quot;, &quot;Database.program2&quot;)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_8">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_8">&#182;</a>
                </div>
                <p>We use a single mutable variable to simulate the server-side
<br  />database.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  var database: Int = 0

</code></pre>
            </td>
        </tr>
        
        <tr id="section_9">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_9">&#182;</a>
                </div>
                <p>We modify the second program to store the first number in the
<br  />database.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def program2(firstNumber: Int) {
    database = firstNumber
    inputNumber(&quot;Second number&quot;, &quot;Database.program3&quot;)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_10">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_10">&#182;</a>
                </div>
                <p>The third program can now recover the first number from the
<br  />database and compute the sum.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def program3(secondNumber: Int) {
    val firstNumber = database

    println(&quot;The sum is &quot; +
      (firstNumber + secondNumber) +
      &quot;.&quot;)
  }
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_11">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_11">&#182;</a>
                </div>
                <p>This works fine if there is only one user of the Web application,
<br  />and if that user only access the pages generated by the three
<br  />programs once, in the correct order. Here is an example
<br  />interaction that shows what works:</p>
<pre><code>// Access first Web page
scala&gt; Database.program1()
First number&gt;
Send answer to Database.program2

// Fill out first form, press "submit"
scala&gt; Database.program2(2)
Second number&gt;
Send answer to Database.program3

// Fill out second form, press "submit"
scala&gt; Database.program3(40)
The sum is 42.
</code></pre>
<p>But if the user keeps the windows with the page generated by
<br  />program2 open, then program3 seems to compute the wrong
<br  />answer. Here is an example interaction that shows some of the
<br  />problems:</p>
<pre><code>// Access first Web page
scala&gt; Database.program1()
First number&gt;
Send answer to Database.program2

// Fill out first form, press "submit"
scala&gt; Database.program2(2)
Second number&gt;
Send answer to Database.program3

// Fill out second form, press "submit"
scala&gt; Database.program3(40)
The sum is 42.

// Go back to first form, change value, press "submit"
scala&gt; Database.program2(10)
Second number&gt;
Send answer to Database.program3

// Go back to result form, press "refresh"
scala&gt; Database.program3(40)
The sum is 50.
</code></pre>
<p>At the very end, it is not clear whether we want <code>42</code> (like
<br  />last time we accessed the very same Web page) or whether
<br  />we want <code>50</code> (because we changed the first number in
<br  />between). Imagine trying to use this Web application in two
<br  />browser tabs, hoping to perform two independent
<br  />calculations. Instead, the value of one brower tab would override
<br  />the value from the other. This is a typical problem with Web
<br  />applications that use server site state to communicate
<br  />information between Web pages.</p>
<h2>Third try: Stateless server</h2>
<p>The problem with the <code>Database</code> solution above is related to the
<br  />use of server-side state. Alternatively, Web developers can use
<br  />the hidden field mechanism of HTML to send the first number back
<br  />to the client, to be resubmitted to the next server-side
<br  />program. We can model this in Scala as follows:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object Stateless {
</code></pre>
            </td>
        </tr>
        
        <tr id="section_12">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_12">&#182;</a>
                </div>
                <p>Both the inputNumber method and the first program are the same
<br  />as in the first try.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def inputNumber(prompt: String, name: String) = {
    println(prompt + &quot;&gt; &quot;)
    println(&quot;Send answer to &quot; + name)
  }

  def program1() {
    inputNumber(&quot;First number&quot;, &quot;Stateless.program2&quot;)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_13">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_13">&#182;</a>
                </div>
                <p>We modify the second program to encode the first number in the
<br  />program the user should call with the second number. In Web
<br  />programming, this corresponds to encoding all information from
<br  />previous forms in the URL or in hidden fields.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def program2(firstNumber: Int) {
    inputNumber(&quot;Second number&quot;, &quot;Stateless.program3(&quot; + firstNumber + &quot;)&quot;)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_14">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_14">&#182;</a>
                </div>
                <p>The third program now gets called with both numbers.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def program3(firstNumber: Int)(secondNumber: Int) {
    println(&quot;The sum is &quot; +
      (firstNumber + secondNumber) +
      &quot;.&quot;)
  }
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_15">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_15">&#182;</a>
                </div>
                <p>With this version of the program, we can go back in the browser
<br  />history and enter other numbers, always computing the correct
<br  />information overall. For example:</p>
<pre><code>// Access first Web page
scala&gt; Stateless.program1()
First number&gt;
Send answer to Stateless.program2

// Fill out first form, press "submit"
scala&gt; Stateless.program2(2)
Second number&gt;
Send answer to Stateless.program3(2)

// Fill out second form, press "submit"
scala&gt; Stateless.program3(2)(40)
The sum is 42.

// Go back to first form, change value, press "submit"
scala&gt; Stateless.program2(10)
Second number&gt;
Send answer to Stateless.program3(10)

// Go back to result form, press "refresh"
scala&gt; Stateless.program3(2)(40)
The sum is 42.
</code></pre>
<p>With this implementation, we could open the application in
<br  />multiple browser tabs, and the calculations in teh various tabs
<br  />would not interact. While this programming style works fine for
<br  />Web applications, it is annoying that we have to change how we
<br  />program just because we move an application from a Desktop
<br  />environment to the Web.</p>
<h2>Continuations</h2>
<p>In a way, the difference between the Desktop and Web versions of
<br  />the simple calculator in our examples is just how <code>inputNumber</code>
<br  />communicates with the user. In a perfect world, we would only
<br  />have to change <code>inputNumber</code> in order to switch between Desktop
<br  />and Web support. But for technical reasons, we had the change the
<br  />whole structure of the program instead.</p>
<p>We could do better if we could somehow get hold of the pending
<br  />computation (or: continuation) at the time when the method
<br  /><code>inputNumber</code> was invoked.</p>
<p>To understand what these continuations are, we look at the
<br  />original, Desktop version of the calculator again.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object Continuations {
</code></pre>
            </td>
        </tr>
        
        <tr id="section_16">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_16">&#182;</a>
                </div>
                <p>The same <code>inputNumber</code> as in <code>Desktop</code> above.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def inputNumber(prompt: String): Int = {
    print(prompt + &quot;&gt; &quot;)
    Integer.parseInt(readLine())
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_17">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_17">&#182;</a>
                </div>
                <p>The same <code>program</code> as in <code>Desctop</code> above.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def variant1() {
    println(&quot;The sum is &quot; +
      (inputNumber(&quot;First number&quot;) +
        inputNumber(&quot;Second number&quot;)) +
      &quot;.&quot;)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_18">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_18">&#182;</a>
                </div>
                <p>The pending computation (or, continuation in the following) of
<br  />the first call to inputNumber is to to take the result of the
<br  />first inputNumber invocation, invoke inputNumber again, then add
<br  />the result of the second invocation to the result of the first
<br  />invocation, and finally display the sum. The overall behavior of
<br  /><code>program</code> is to first invoke <code>inputNumber</code> and then execute the
<br  />continuation. We can make this split between what happens first
<br  />and what the continuation is explicit by representing the
<br  />continuation as a function:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def variant2() {
    val cont1 = (firstNumber: Int) =&gt; {
      println(&quot;The sum is &quot; +
        (firstNumber +
          inputNumber(&quot;Second number&quot;)) +
        &quot;.&quot;)
    }

    cont1(inputNumber(&quot;First number&quot;))
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_19">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_19">&#182;</a>
                </div>
                <p>Note that <code>variant1</code> and <code>variant2</code> do exactly the same thing,
<br  />but in <code>variant2</code>, it is clearer what happens first and what the
<br  />continuation is. This continuation contains another invocation of
<br  />inputNumber. We can make the continuation of this second
<br  />invocation of inputNumber explicit as follows:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def variant3() {
    val cont1 = (firstNumber: Int) =&gt; {
      val cont2 = (secondNumber: Int) =&gt; {
        println(&quot;The sum is &quot; +
          (firstNumber +
            secondNumber) +
          &quot;.&quot;)
      }

      cont2(inputNumber(&quot;SecondNumber&quot;))
    }

    cont1(inputNumber(&quot;First number&quot;))
  }
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_20">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_20">&#182;</a>
                </div>
                <p>Note that inside <code>cont2</code>, we are using the variable <code>firstNumber</code>
<br  />that is in scope as the argument of <code>cont1</code>. In other words, the
<br  />value of the variable <code>firstNumber</code> is stored in the closure of
<br  /><code>cont2</code>.</p>
<h2>Continuation-passing style</h2>
<p>So far, we have made the continuations of the invocations of
<br  /><code>inputNumber</code> explicit without being able to use them for
<br  />anything good. The key for using continuations to achieve control
<br  />effects is to change functions to accept their continuation. In
<br  />this case, instead of calling something like</p>
<pre><code>cont1(inputNumber("First number"))
</code></pre>
<p>we want to call something like:</p>
<pre><code>inputNumber("First number", cont1)
</code></pre>
<p>That is, instead of waiting for <code>inputNumber</code> to return a number
<br  />and then invoking the continuation ourselves, we want to pass the
<br  />continuation to <code>inputNumber</code> and have it invoke the continuation
<br  />for us. This style of passing continuations to functions is
<br  />called <em>continuation-passing style</em> (or short: CPS).</p>
<p>We implement a version of <code>program</code> in continuation-passing style
<br  />in a class with an abstract method for <code>inputNumber</code>. Later, we
<br  />can specialize <code>inputNumber</code> to support Desktop-style or
<br  />Web-style user interaction without further changes to <code>program</code>,
<br  />as promised.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>abstract class CPS {
</code></pre>
            </td>
        </tr>
        
        <tr id="section_21">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_21">&#182;</a>
                </div>
                <p>An abstract version of <code>inputNumber</code> that accepts a
<br  />continuation as an additional argument. When finished with the
<br  />user interaction, instead of returning a number, it invokes
<br  />this continuation with the number as argument. Traditionally,
<br  />the continuation to call after a function finishes is called
<br  /><code>k</code>.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def inputNumber(prompt: String, k: Int =&gt; Unit)

</code></pre>
            </td>
        </tr>
        
        <tr id="section_22">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_22">&#182;</a>
                </div>
                <p>We can now write the program in continuation-passing style:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def variant1() {
    val cont1 = (firstNumber: Int) =&gt; {
      val cont2 = (secondNumber: Int) =&gt; {
        println(&quot;The sum is &quot; +
          (firstNumber +
            secondNumber) +
          &quot;.&quot;)
      }

      inputNumber(&quot;SecondNumber&quot;, cont2)
    }

    inputNumber(&quot;First number&quot;, cont1)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_23">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_23">&#182;</a>
                </div>
                <p>Equivalently, we can use anonymous functions for the
<br  />continuations:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def variant2() {
    inputNumber(&quot;First number&quot;, firstNumber =&gt;
      inputNumber(&quot;SecondNumber&quot;, secondNumber =&gt;
        println(&quot;The sum is &quot; +
          (firstNumber +
            secondNumber) +
          &quot;.&quot;)
      )
    )
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_24">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_24">&#182;</a>
                </div>
                <p>Note that in <code>variant2</code>, the nested calls to inputNumber appear
<br  />in their eventual order of execution. That's why programs in CPS
<br  />are usually written with anonymous functions for the
<br  />continuations, as in <code>variant2</code>.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_25">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_25">&#182;</a>
                </div>
                <h2>CPS, Desktop-version</h2>
<p>We can now easily provide an implementation for <code>inputNumber</code>
<br  />that works for Desktop programs:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object CPSDesktop extends CPS {
  def inputNumber(prompt: String, k: Int =&gt; Unit) {
    print(prompt + &quot;&gt; &quot;)
    k(Integer.parseInt(readLine()))
  }
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_26">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_26">&#182;</a>
                </div>
                <p>This implementation of <code>inputNumber</code> simply calls the
<br  />continuation after the user enters the number. This is the CPS
<br  />version of <code>Desktop.inputNumber</code>. Overall, the interaction with
<br  /><code>CPSDesktop.variant1</code> (or <code>variant2</code>) is just like with
<br  /><code>Dektop.program</code>:</p>
<pre><code>scala&gt; CPSDesktop.variant1()
First number&gt; 2
SecondNumber&gt; 30
The sum is 42.
</code></pre>
<h2>CPS, Web-version</h2>
<p>The implementation of <code>inputNumber</code> for Web programs needs to
<br  />generate a Web page and arrange for the server to invoke the
<br  />continuation once the user entered the number on the client. This
<br  />can be implemented, say, by associating to a contination a
<br  />unique ID, store the continuation in a database on the server
<br  />using this ID, and storing the ID in the form such that it gets
<br  />submitted back to the server once the client presses the submit
<br  />button.</p>
<p>Here is code illustrating this idea. For simplicity we assume
<br  />that all web forms return a single integer value.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object CPSWeb extends CPS {
</code></pre>
            </td>
        </tr>
        
        <tr id="section_27">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_27">&#182;</a>
                </div>
                <p>A database of continuations.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  var database: Map[String, Int =&gt; Unit] = Map()

</code></pre>
            </td>
        </tr>
        
        <tr id="section_28">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_28">&#182;</a>
                </div>
                <p>Generating unique identifiers.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  var counter: Int = 0
  def freshName: String = {
    counter += 1
    &quot;program&quot; + counter
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_29">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_29">&#182;</a>
                </div>
                <p>This version of <code>inputNumber</code> stores the continuation in the
<br  />database and then stops executing (by not calling any
<br  />continuation).</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def inputNumber(prompt: String, k: Int =&gt; Unit) {
    println(prompt + &quot;&gt; &quot;)
    val name = freshName
    database += (name -&gt; k)
    println(&quot;Send answer to &quot; + name)
  }

</code></pre>
            </td>
        </tr>
        
        <tr id="section_30">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_30">&#182;</a>
                </div>
                <p>The client should call the following function with the name of
<br  />the program to execute as well as the number entered by the
<br  />user.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def call(name: String, answer: Int) {
    database(name)(answer)
  }
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_31">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_31">&#182;</a>
                </div>
                <p>The interaction with <code>CPSWeb</code> allows multiple tabs etc, just like
<br  />for the <code>Stateless</code> version:</p>
<pre><code>// Access first Web page
scala&gt; CPSWeb.variant1()
First number&gt;
Send answer to program1

// Fill out first form, press "submit"
scala&gt; CPSWeb.call("program1", 2)
SecondNumber&gt;
Send answer to program2

// Fill out second form, press "submit"
scala&gt; CPSWeb.call("program2", 40)
The sum is 42.

// Go back to first form, change value, press "submit"
scala&gt; CPSWeb.call("program1", 10)
SecondNumber&gt;
Send answer to program3

// Go back to result form, press "refresh"
scala&gt; CPSWeb.call("program2", 40)
The sum is 42.
</code></pre>
<p>In this version of the Web application, all special handling of
<br  />client-server communication is in the <code>inputNumber</code> method, and
<br  />the <code>program</code> method is the same as in the (CPS) Desktop
<br  />version. This is possible because programming in
<br  />continuation-passing style allows us to abstract over the order
<br  />of execution.</p>
<h2>Three properties of programs in CPS</h2>
<p>Let's take a step back and look again what it means if a program
<br  />is in continuation-passing style. Programs in CPS have the
<br  />following properties:</p>
<ol>
<li>All calls are in tail position.</li>
<li>All functions take continuation arguments.</li>
<li>No function returns a value.</li>
</ol>
<p>About the first property: Something is in tail position
<br  />if in some executions of a function, it is the last thing that
<br  />happens before the function is finished. For example, consider
<br  />this function:</p>
<pre><code>def a() {
  if b() {
    c()
  else
    d(e())
  }
}
</code></pre>
<ul>
<li><p>The call to b() is not in tail position, because after b() is
<br  />called, we always have to call either c() or e() and d()
<br  />before the function a() is finished.</p>
</li>
<li><p>The call to c() is in tail position, because sometimes (when
<br  />b() returns true), the call to c() is the last thing that
<br  />happens in the execution of the function a().</p>
</li>
<li><p>The call to e() is not in tail position, because after e() is
<br  />called, we always have to call d() before the function a() is
<br  />finished.</p>
</li>
<li><p>the call to d() is in tail positions, because sometimes (when
<br  />b() returns false), the call to c() is the last thing that
<br  />happens in the execution of the function a().</p>
</li>
</ul>
<p>The first property also implies that the order of execution is
<br  />very clear and explicit: Since every call is in tail position,
<br  />the first thing a function does has to be the last thing the
<br  />function does. In other words, every function only does one thing
<br  />and then calls the continuation to continue execution with the
<br  />next thing. This leads to a convenient sequentialization of the
<br  />program into lots of one-thing-per-step functions.</p>
<p>About the second property: Since <em>all</em> functions in a program
<br  />take continuation arguments, this implies that the transformation
<br  />to continuation-passing style has to be global. If we want to use
<br  />continuations somewhere in our program, we have to transform the
<br  />whole program to continuation-passing style, including all libraries.</p>
<p>About the third property: It wouldn't make sense to return the
<br  />value, because the call to that function would be in tail
<br  />position (per the first property), so no other function that
<br  />could use that value for something would be executed after the
<br  />return of the value-returning function.</p>
<p>Our understanding of these properties will help us to formalize
<br  />the transformation of arbitrary FAE programs into
<br  />continuation-passing style in the next lecture.</p>
<h2>Three steps for transforming into CPS by hand</h2>
<p>At some point in the lecture today, we transformed
<br  /><code>Desktop.program</code> to CPS. We ended up with <code>CPS.variant2</code>. Let's
<br  />look again at how we can transform an arbitrary piece of code
<br  />into continuation-passing style, by hand. We do this in the
<br  />following three steps:</p>
<ol>
<li>give a name to the result of every nontrivial subexpression.</li>
<li>choose an evaluation order for the nontrivial subexpressions.</li>
<li>use continuations instead of helper variables</li>
</ol>
<p>Here is the transformation we have seen before, using these three
<br  />steps. We start with:</p>
<pre><code>def program() {
  println("The sum is " +
    (inputNumber("First number") +
      inputNumber("Second number")) +
    ".")
}
</code></pre>
<p>In the first step, we assign the following names to the subexpressions:</p>
<ul>
<li>firstNumber = inputNumber(&ldquo;First number&rdquo;)</li>
<li>secondNumber = inputNumber(&ldquo;Second number&rdquo;)</li>
</ul>
<p>Here, we treat the + operator as trivial. We could also treat it
<br  />as non-trivial and give names to subexpressions involving the +
<br  />operator. Then we would have to CPS-transform also the
<br  />implementation of +. We will talk about the difference between
<br  />trivial and nontrivial expressions more in the next lecture.</p>
<p>In the second step, we choose an evaluation order. Let's choose
<br  />to compute firstNumber first, and secondNumber second. After this
<br  />step, we rewrite the program as follows:</p>
<pre><code>def program() {
  val firstNumber = inputNumber("First number")
  val secondNumber = inputNumber("Second number")
  println("The sum is " +
    (firstNumber +
      secondNumber) +
    ".")
}
</code></pre>
<p>In the third step, we add an continuation argument to program,
<br  />call that continuation instead of returning a result, and we
<br  />rewrite</p>
<pre><code>val name = function(args)
rest
</code></pre>
<p>to</p>
<pre><code>function(args, name =&gt;
  rest).
</code></pre>
<p>In this case, we get the following program, which is in
<br  />continuation-passing style:</p>
<pre><code>def program(k: Int =&gt; Unit) {
  inputNumber("First number", firstNumber =&gt;
    inputNumber("Second number", secondNumber =&gt;
      println("The sum is " +
        (firstNumber +
          secondNumber) +
        ".")))
}
</code></pre>
<p>Note that in this step, we assume that inputNumber has also been
<br  />transformed to continuation-passing style. So we have to apply
<br  />the three steps to every function in our program.</p>
<h2>Another example: fibonacci numbers</h2>
<p>Here is another simple example for how to transform into CPS
<br  />manually: The good old fibonacci function. We start with:</p>
<pre><code>def fibonacci(n: Int): Int =
  if (n &lt; 2)
    1
  else
    fibonacci(n - 1) + fibonacci(n - 2)
</code></pre>
<p>In the first step, we give names to every nontrivial
<br  />subexpression:</p>
<ul>
<li>a = fibonacci(n - 1)</li>
<li>b = fibonacci(n - 2)</li>
</ul>
<p>In the second step, we choose an evaluation order for the
<br  />nontrivial subexpressions. The usual choice would be to evaluate
<br  />a first, and then b. But in continuation-passing style, we can
<br  />also choose to evaluate b first, and then a. After all, with
<br  />continuations, we are more flexible in what we want to evaluate
<br  />when. Let's choose that unusual evaluation order:</p>
<pre><code>def fibonacci(n: Int): Int =
  if (n &lt; 2)
    1
  else {
    val b = fibonacci(n - 2)
    val a = fibonacci(n - 1)
    a + b
  }
</code></pre>
<p>In the third step, we add a continuation argument and use
<br  />continuations everywhere:</p>
<pre><code>def fibonacci(n: Int, k: Int =&gt; Unit) {
  if (n &lt; 2)
    k(1)
  else
    fibonacci(n - 2, b =&gt;
      fibonacci(n - 1, a =&gt;
        k(a + b)))
}
</code></pre>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'></code></pre>
            </td>
        </tr>
        
        </tbody>
    </table>
</div>
</body>
</html>
