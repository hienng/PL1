<!DOCTYPE html>
<html>
<head>
    <title>03-ae.scala</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <style type="text/css">
        /*--------------------- Layout and Typography ----------------------------*/
        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
            font-size: 15px;
            line-height: 22px;
            color: #252519;
            margin: 0; padding: 0;
        }
        a {
            color: #261a3b;
        }
        a:visited {
            color: #261a3b;
        }
        p {
            margin: 0 0 15px 0;
        }
        h4, h5, h6 {
            color: #333;
            padding: 6px 0 6px 0;
            font-size: 13px;
        }
        h2, h3 {
            padding-bottom: 15px;
            color: #000;
            overflow: hidden;
        }
        h1 {
            /*padding-top: 40px;*/
            padding-bottom: 15px;
            color: #000;
        }
        #container {
            position: relative;
        }
        /*#background {
            position: fixed;
            top: 0; left: 525px; right: 0; bottom: 0;
            background: #f5f5ff;
            border-left: 1px solid #e5e5ee;
            z-index: -1;
        }*/
        #jump_to, #jump_page {
            background: white;
            -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777;
            -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px;
            font: 10px Arial;
            text-transform: uppercase;
            cursor: pointer;
            text-align: right;
        }
        #jump_to, #jump_wrapper {
            position: fixed;
            right: 0; top: 0;
            padding: 5px 10px;
        }
        #jump_wrapper {
            padding: 0;
            display: none;
        }
        #jump_to:hover #jump_wrapper {
            display: block;
        }
        #jump_page {
            padding: 5px 0 3px;
            margin: 0 0 25px 25px;
        }
        #jump_page .source {
            display: block;
            padding: 5px 10px;
            text-decoration: none;
            border-top: 1px solid #eee;
        }
        #jump_page .source:hover {
            background: #f5f5ff;
        }
        #jump_page .source:first-child {
        }
        table td {
            border: 0;
            outline: 0;
        }
        td.docs, th.docs {
            max-width: 450px;
            min-width: 450px;
            min-height: 5px;
            padding: 10px 25px 1px 50px;
            overflow-x: hidden;
            vertical-align: top;
            text-align: left;
        }
        .docs pre {
            margin: 15px 0 15px;
            padding-left: 15px;
        }
        .docs p tt, .docs p code, .doc code {
            background: #f8f8ff;
            border: 1px solid #dedede;
            font-size: 12px;
            padding: 0 0.2em;
        }
        .pilwrap {
            position: relative;
        }
        .pilcrow {
            font: 12px Arial;
            text-decoration: none;
            color: #454545;
            position: absolute;
            top: 3px; left: -20px;
            padding: 1px 2px;
            opacity: 0;
            -webkit-transition: opacity 0.2s linear;
        }
        td.docs:hover .pilcrow {
            opacity: 1;
        }
        td.code, th.code {
            padding: 10px 10px 10px 50px;
            width: 100%;
            vertical-align: top;
            background: #f5f5ff;
            border-left: 1px solid #e5e5ee;
        }
        pre, tt, code {
            font-size: 12px; line-height: 18px;
            font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
            margin: 0; padding: 0;
        }

        /*---------------------- Prettify Syntax Highlighting -----------------------------*/
        .str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun{color:#660}.pln{color:#000}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec{color:#606}pre.prettyprint{padding:2px;border:1px solid #888}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}@media print{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun{color:#440}.pln{color:#000}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}

        table.doc { margin-bottom: 20px; }
        td.doc { border-bottom: 1px dashed #708090; }
        td.param { font-weight: bold; }
        td.return { font-weight: bold; text-decoration: underline; }
    </style>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.js" type="text/javascript"></script>
    <script src="https://google-code-prettify.googlecode.com/svn/trunk/src/lang-scala.js" type="text/javascript"></script>
</head>

<body onload="prettyPrint()">
<div id="container">
    <div id="background"></div>
    <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
            <div id="jump_page">
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/01-intro.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/01-intro.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/02-desugaring.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/02-desugaring.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/03-ae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/03-ae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/04-wae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/04-wae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/05-f1wae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/05-f1wae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/06-fae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/06-fae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/07-lcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/07-lcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/08-rcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/08-rcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/09-bcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/09-bcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/10-gc.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/10-gc.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/11-syntacticvsmeta.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/11-syntacticvsmeta.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/12-churchencoding.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/12-churchencoding.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/13-continuations-1.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/13-continuations-1.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/14-continuations-2.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/14-continuations-2.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/17-firstclasscontinuations.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/17-firstclasscontinuations.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/18-monads.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/18-monads.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/19-monads.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/19-monads.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/20-iomonad.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/20-iomonad.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/21-defunctionalization.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/21-defunctionalization.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/22-typesystems.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/22-typesystems.html
                </a>
                
            </div>
        </div>
    </div>

    <table cellpadding="0" cellspacing="0">
        <thead>
        <tr>
            <th class="docs">
                <h1>03-ae.scala</h1>
            </th>
            <th class="code"></th>
        </tr>
        </thead>
        <tbody>
        
        <tr id="section_0">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_0">&#182;</a>
                </div>
                <h1>Arithmetic expressions with variables</h1>
<p>Let us now consider an extension of the arithmetic expression language with variables. We do this by a new kind of expression, which we call Identifier, or Id.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object AEId {

sealed abstract class Exp 

case class Num(n: Int) extends Exp
case class Add(lhs: Exp, rhs: Exp) extends Exp
case class Mul(lhs: Exp, rhs: Exp) extends Exp
case class Id(x: Symbol) extends Exp 
// Symbols are similar to strings, but they are implicitly &quot;canonicalized&quot; 
// (meaning all instances of the same symbol point to a unique copy, in other words, 
// they are not cloned but shared) and  can hence be compared efficiently. 
// Unlike strings, they can not be manipulated.
// They can be constructed by prefixing an identifier with a '

</code></pre>
            </td>
        </tr>
        
        <tr id="section_1">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_1">&#182;</a>
                </div>
                <p>Here is a sample program written in this language, directly written down using case class constructors</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'> val test0 = Add(Mul(Id('x),Num(2)),Add(Id('y),Id('y)))

</code></pre>
            </td>
        </tr>
        
        <tr id="section_2">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_2">&#182;</a>
                </div>
                <p>With a proper parser we could choose a syntax like &ldquo;x*2+y+y&rdquo;. We do not care much about concrete syntax and parsing, though. That said, to make writing examples less verbose, Scala's implicits come to the rescue.</p>
<p>Calls to implicit functions are inserted automatically by the compiler if they help to restore well-typedness. For instance, we can define:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>implicit def num2exp(n: Int) = Num(n)
implicit def sym2exp(x: Symbol) = Id(x)


 val test = Add(Mul('x,2),Add('y,'y))

</code></pre>
            </td>
        </tr>
        
        <tr id="section_3">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_3">&#182;</a>
                </div>
                <p>To give meaning to identifiers, we use <em>environments</em>. Environments are mappings from Identifiers (which we represent as symbols) to Values. In our simple language the only values are integers, hence:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>type Env = Map[Symbol,Int]

</code></pre>
            </td>
        </tr>
        
        <tr id="section_4">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_4">&#182;</a>
                </div>
                <p>An evaluator (or interpreter) for this language takes an expression and an environment as parameter and produces a value - in this case &ldquo;Int&rdquo;. The interpreter illustrates how pattern matching over case classes works.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'> def eval(e: Exp, env: Env) : Int = e match {
  case Num(n) =&gt; n
  case Id(x) =&gt; env(x)
  case Add(l,r) =&gt; eval(l,env) + eval(r,env)
  case Mul(l,r) =&gt; eval(l,env) * eval(r,env)
}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_5">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_5">&#182;</a>
                </div>
                <p>A different (and arguably more 'object-oriented') way to implement this evaluator would be to add an abstract &ldquo;eval&rdquo; method to the Exp class and override it in all subclasses, each implementation corresponding to its corresponding case in the pattern match. The choice between these alternatives matters, since they support different dimensions of extensibility.</p>
<p>We will mainly use the more functional style using pattern matching, because it matches better to the order in which we present these topics in the lecture. To try the example, we need a sample environment that gives values to the (free) variables in the sample expression. The test environment also illustrates how Scala supports direct definitions of constant maps.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>val testEnv = Map('x -&gt; 3, 'y -&gt; 4)

</code></pre>
            </td>
        </tr>
        
        <tr id="section_6">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_6">&#182;</a>
                </div>
                <p>We can automatically test our evaluator using assert :</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>assert( eval(test, testEnv) == 14)

}


</code></pre>
            </td>
        </tr>
        
        <tr id="section_7">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_7">&#182;</a>
                </div>
                <p>We will now learn a different way to encode algorithms that operate on expressions (like the evaluator). To this end, we will now use so-called &ldquo;folds&rdquo;. Folds are well-known for lists, but the concept is more general and applies to arbitrary algebraic data types.</p>
<p>We will present folds in such a style that they resemble visitors as known from the OO design pattern literature. They correspond to so-called &ldquo;internal visitors&rdquo; in which the traversal is encoded within the &ldquo;accept&rdquo; function.</p>
<p>An internal visitor consists of one function for each syntactic construct of the language. It has a type parameter that determines the &ldquo;return type&rdquo; of invoking the visitor on an expression. This type parameter is used in all positions in which the original syntax specifies a subexpression.</p>
<p>Internal visitors also correspond to a &ldquo;bottom-up&rdquo; traversal of the syntax tree.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object Visitors {
  case class Visitor[T](num: Int =&gt; T, add: (T,T)=&gt;T)
  // an alternative to this design is to define num and add as abstract methods
  // and then create concrete visitors by subclassing or trait composition.

</code></pre>
            </td>
        </tr>
        
        <tr id="section_8">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_8">&#182;</a>
                </div>
                <p>The fold function itself applies a visitor to an expression. Note that the recursion is performed in the fold function, hence all visitors are not recursive.</p>
<p>Also note that this design enforces that all algorithms specified via this visitor interfaces are compositional by design. This means that the recursion structure of the algorithm corresponds to the recursion structure of the expression. Put in another way, it means that the semantics (in terms of the meta-language) of a composite  expression is determined by the semantics of the subexpressions; the syntax of the subexpressions is irrelevant.</p>
<p>Compositional specifications are particularly nice because they enable &ldquo;equational reasoning&rdquo;: Subexpressions can be replaced by other subexpressions with the same semantics without changing the semantics of the whole.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  sealed abstract class Exp 

  case class Num(n: Int) extends Exp
  case class Add(lhs: Exp, rhs: Exp) extends Exp
 
  def foldExp[T](v: Visitor[T], e: Exp) : T = {
    e match {
      case Num(n) =&gt; v.num(n)
      case Add(l,r) =&gt; v.add(foldExp(v,l), foldExp(v,r))
    }
  }
</code></pre>
            </td>
        </tr>
        
        <tr id="section_9">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_9">&#182;</a>
                </div>
                <p>Here is our evaluator from above rephrased using the visitor infrastructure.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  val evalVisitor = Visitor[Int]( x =&gt; x, (a,b)=&gt;a+b) 

</code></pre>
            </td>
        </tr>
        
        <tr id="section_10">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_10">&#182;</a>
                </div>
                <p>We can of course also restore the original interface of eval</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  def eval(e: Exp) = foldExp(evalVisitor,e)

</code></pre>
            </td>
        </tr>
        
        <tr id="section_11">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_11">&#182;</a>
                </div>
                <p>Let's test whether it works.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  assert( eval(Add(Add(Num(1),Num(2)),Num(3))) == 6)

</code></pre>
            </td>
        </tr>
        
        <tr id="section_12">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_12">&#182;</a>
                </div>
                <p>We can of course also apply other algorithms using visitors, such as counting the number of &ldquo;Num&rdquo; literals, or printing to a string:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  val countVisitor = Visitor[Int]( _=&gt;1, _+_) 
  val printVisitor = Visitor[String](_.toString, &quot;(&quot;+_+&quot;+&quot;+_+&quot;)&quot;)

}

</code></pre>
            </td>
        </tr>
        
        <tr id="section_13">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_13">&#182;</a>
                </div>
                <p>Let's now try the same with the AE language with identifiers. It all works in the same way:</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object AEIdVisitor {
  import AEId._
  
  case class Visitor[T](num: Int =&gt; T, add: (T,T)=&gt;T, mul: (T,T)=&gt;T, id: Symbol=&gt;T)
  val expVisitor = Visitor[Exp]( Num(_), Add(_,_), Mul(_,_), Id(_)  )
  val countVisitor = Visitor[Int]( _=&gt;1, _+_, _+_, _=&gt;0) 
  val printVisitor = Visitor[String](_.toString, &quot;(&quot;+_+&quot;+&quot;+_+&quot;)&quot;, _+&quot;*&quot;+_, _.x.name)

  def foldExp[T](v: Visitor[T], e: Exp) : T = {
    e match {
      case Num(n) =&gt; v.num(n)
      case Add(l,r) =&gt; v.add(foldExp(v,l), foldExp(v,r))
      case Mul(l,r) =&gt; v.mul(foldExp(v,l), foldExp(v,r))
      case Id(x) =&gt; v.id(x)
    }
  }

  def countNums(e: Exp) = foldExp(countVisitor, e) 

  assert(countNums(test) == 1)

</code></pre>
            </td>
        </tr>
        
        <tr id="section_14">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_14">&#182;</a>
                </div>
                <p>However, what about the evaluator? If we instantiate T=Int, then how can we access the environment? Insight: For evaluation, we must instantiate T with a function type <code>Env =&gt; Int</code>! This way of transforming a multi-argument function into a single-argument higher-order function is called <em>currying</em>.</p>

            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>  val evalVisitor = Visitor[Env=&gt;Int]( 
     env=&gt;_, 
     (a,b)=&gt;env=&gt;a(env)+b(env), 
     (a,b)=&gt;env=&gt;a(env)*b(env), 
     x=&gt;env =&gt; env(x)) 
}

 
</code></pre>
            </td>
        </tr>
        
        </tbody>
    </table>
</div>
</body>
</html>
